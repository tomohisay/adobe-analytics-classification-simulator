<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adobe Analytics 分類シミュレーター</title>
    <style>
        :root {
            --primary-color: #1473E6;
            --secondary-color: #0D66D0;
            --success-color: #2D9D78;
            --warning-color: #E68619;
            --bg-color: #F5F5F5;
            --card-bg: #FFFFFF;
            --text-color: #323232;
            --border-color: #E1E1E1;
            --workspace-header: #4B4B4B;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', 'Hiragino Sans', 'Meiryo', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 30px;
            margin-bottom: 30px;
            border-radius: 8px;
        }

        header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .concept-box {
            background: var(--card-bg);
            border-left: 4px solid var(--primary-color);
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 0 8px 8px 0;
        }

        .concept-box h2 {
            font-size: 16px;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .concept-box p {
            font-size: 14px;
            color: #666;
        }

        .flow-diagram {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .flow-item {
            background: var(--bg-color);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }

        .flow-arrow {
            color: var(--primary-color);
            font-size: 20px;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .tab:hover {
            border-color: var(--primary-color);
        }

        .tab.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .tab-content {
            display: none;
            background: var(--card-bg);
            padding: 25px;
            border-radius: 0 8px 8px 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
        }

        .usecase-desc {
            background: #FFF8E6;
            border-left: 4px solid var(--warning-color);
            padding: 15px;
            margin-bottom: 25px;
            border-radius: 0 8px 8px 0;
            font-size: 14px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .section h3 {
            font-size: 16px;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section h3 .badge {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: normal;
        }

        .badge-raw {
            background: #FFE6E6;
            color: #CC3333;
        }

        .badge-classification {
            background: #E6F0FF;
            color: var(--primary-color);
        }

        .badge-result {
            background: #E6F9F0;
            color: var(--success-color);
        }

        .badge-workspace {
            background: #F0E6FF;
            color: #7B2CBF;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border: 1px solid var(--border-color);
        }

        th {
            background: var(--bg-color);
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .table-wrapper {
            max-height: 300px;
            overflow-y: auto;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .table-wrapper table {
            border: none;
        }

        .table-wrapper th,
        .table-wrapper td {
            border-left: none;
            border-right: none;
        }

        .table-wrapper tr:first-child th {
            border-top: none;
        }

        .table-wrapper tr:last-child td {
            border-bottom: none;
        }

        .key-cell {
            font-family: 'Consolas', 'Monaco', monospace;
            background: #F8F8F8;
            font-size: 12px;
        }

        .classified-cell {
            background: #F0FFF4;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--secondary-color);
        }

        .btn-secondary {
            background: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .edit-controls {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            font-size: 18px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 13px;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .stats-bar {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-item {
            background: var(--card-bg);
            padding: 15px 25px;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }

        .stat-item .label {
            font-size: 12px;
            color: #666;
        }

        .stat-item .value {
            font-size: 24px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1001;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        footer {
            text-align: center;
            padding: 30px;
            color: #999;
            font-size: 12px;
        }

        /* Workspace風の分析テーブル */
        .analysis-section {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px dashed var(--border-color);
        }

        .analysis-section h3 {
            font-size: 18px;
            margin-bottom: 20px;
            color: var(--workspace-header);
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .analysis-panel {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .analysis-panel-header {
            background: var(--workspace-header);
            color: white;
            padding: 12px 15px;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .analysis-panel-header .icon {
            width: 16px;
            height: 16px;
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
        }

        .analysis-table {
            width: 100%;
            font-size: 12px;
        }

        .analysis-table th {
            background: #F8F8F8;
            padding: 10px 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
            position: static;
        }

        .analysis-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #EEEEEE;
        }

        .analysis-table tr:last-child td {
            border-bottom: none;
        }

        .analysis-table .metric {
            text-align: right;
            font-family: 'Consolas', 'Monaco', monospace;
        }

        .analysis-table .total-row {
            background: #F8F8F8;
            font-weight: 600;
        }

        .analysis-table .dimension {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .bar-cell {
            position: relative;
        }

        .bar-bg {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: rgba(20, 115, 230, 0.1);
            z-index: 0;
        }

        .bar-value {
            position: relative;
            z-index: 1;
        }

        .unclassified-note {
            padding: 10px 15px;
            background: #FFF8E6;
            font-size: 11px;
            color: #996600;
            border-top: 1px solid var(--border-color);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            header {
                padding: 20px;
            }

            .tab {
                padding: 10px 15px;
                font-size: 12px;
            }

            .tab-content {
                padding: 15px;
            }

            th, td {
                padding: 8px;
                font-size: 12px;
            }

            .stat-item {
                padding: 10px 15px;
            }

            .stat-item .value {
                font-size: 18px;
            }

            .analysis-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Adobe Analytics 分類シミュレーター</h1>
            <p>eVarやprop変数の値に属性を追加する「分類（Classification）」機能を体験できます</p>
        </header>

        <div class="concept-box">
            <h2>分類（Classification）とは？</h2>
            <p>Adobe Analyticsで計測した変数の値（キー）に対して、追加の属性情報をマッピングする機能です。これにより、レポートでより詳細なディメンションで分析が可能になります。</p>
            <div class="flow-diagram">
                <span class="flow-item">計測データ（キー値）</span>
                <span class="flow-arrow">+</span>
                <span class="flow-item">分類テーブル</span>
                <span class="flow-arrow">=</span>
                <span class="flow-item">分類済みデータ</span>
            </div>
        </div>

        <div class="stats-bar" id="statsBar">
            <div class="stat-item">
                <div class="label">元データ件数</div>
                <div class="value" id="rawDataCount">0</div>
            </div>
            <div class="stat-item">
                <div class="label">分類ルール数</div>
                <div class="value" id="classificationCount">0</div>
            </div>
            <div class="stat-item">
                <div class="label">分類済み件数</div>
                <div class="value" id="classifiedCount">0</div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="tracking">広告トラッキングコード</div>
            <div class="tab" data-tab="url">URL分類</div>
            <div class="tab" data-tab="member">会員ID分類</div>
        </div>

        <!-- 広告トラッキングコード分類 -->
        <div class="tab-content active" id="tracking-content">
            <div class="usecase-desc">
                <strong>ユースケース:</strong> 広告のトラッキングコードを分類して、キャンペーン名・媒体・クリエイティブなどの属性でレポートを作成できるようにします。
            </div>

            <div class="section">
                <div class="section-header">
                    <h3>元データ（Raw Data）<span class="badge badge-raw">eVar1: tracking_code</span></h3>
                </div>
                <div class="table-wrapper">
                    <table id="tracking-raw-table">
                        <thead>
                            <tr>
                                <th>日時</th>
                                <th>トラッキングコード (eVar1)</th>
                                <th>ページビュー</th>
                                <th>コンバージョン</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="edit-controls">
                    <button class="btn btn-secondary" onclick="openAddRawDataModal('tracking')">+ データ追加</button>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h3>分類テーブル <span class="badge badge-classification">Classification</span></h3>
                </div>
                <div class="table-wrapper">
                    <table id="tracking-classification-table">
                        <thead>
                            <tr>
                                <th>キー（トラッキングコード）</th>
                                <th>キャンペーン名</th>
                                <th>媒体</th>
                                <th>クリエイティブ</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="edit-controls">
                    <button class="btn btn-primary" onclick="openAddClassificationModal('tracking')">+ 分類ルール追加</button>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h3>分類結果 <span class="badge badge-result">Classified Data</span></h3>
                </div>
                <div class="table-wrapper">
                    <table id="tracking-result-table">
                        <thead>
                            <tr>
                                <th>日時</th>
                                <th>トラッキングコード</th>
                                <th>キャンペーン名</th>
                                <th>媒体</th>
                                <th>クリエイティブ</th>
                                <th>PV</th>
                                <th>CV</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- 分析例セクション -->
            <div class="analysis-section">
                <h3>分析例 <span class="badge badge-workspace">Workspace風レポート</span></h3>
                <p style="font-size: 13px; color: #666; margin-bottom: 20px;">分類を設定することで、以下のような集計レポートをWorkspaceで作成できるようになります。</p>
                <div class="analysis-grid" id="tracking-analysis"></div>
            </div>
        </div>

        <!-- URL分類 -->
        <div class="tab-content" id="url-content">
            <div class="usecase-desc">
                <strong>ユースケース:</strong> ページURLを分類して、ページカテゴリ・コンテンツタイプ・製品ラインなどの属性でレポートを作成できるようにします。
            </div>

            <div class="section">
                <div class="section-header">
                    <h3>元データ（Raw Data）<span class="badge badge-raw">prop1: page_url</span></h3>
                </div>
                <div class="table-wrapper">
                    <table id="url-raw-table">
                        <thead>
                            <tr>
                                <th>日時</th>
                                <th>ページURL (prop1)</th>
                                <th>ページビュー</th>
                                <th>滞在時間(秒)</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="edit-controls">
                    <button class="btn btn-secondary" onclick="openAddRawDataModal('url')">+ データ追加</button>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h3>分類テーブル <span class="badge badge-classification">Classification</span></h3>
                </div>
                <div class="table-wrapper">
                    <table id="url-classification-table">
                        <thead>
                            <tr>
                                <th>キー（ページURL）</th>
                                <th>ページカテゴリ</th>
                                <th>コンテンツタイプ</th>
                                <th>製品ライン</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="edit-controls">
                    <button class="btn btn-primary" onclick="openAddClassificationModal('url')">+ 分類ルール追加</button>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h3>分類結果 <span class="badge badge-result">Classified Data</span></h3>
                </div>
                <div class="table-wrapper">
                    <table id="url-result-table">
                        <thead>
                            <tr>
                                <th>日時</th>
                                <th>ページURL</th>
                                <th>ページカテゴリ</th>
                                <th>コンテンツタイプ</th>
                                <th>製品ライン</th>
                                <th>PV</th>
                                <th>滞在時間</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- 分析例セクション -->
            <div class="analysis-section">
                <h3>分析例 <span class="badge badge-workspace">Workspace風レポート</span></h3>
                <p style="font-size: 13px; color: #666; margin-bottom: 20px;">分類を設定することで、以下のような集計レポートをWorkspaceで作成できるようになります。</p>
                <div class="analysis-grid" id="url-analysis"></div>
            </div>
        </div>

        <!-- 会員ID分類 -->
        <div class="tab-content" id="member-content">
            <div class="usecase-desc">
                <strong>ユースケース:</strong> 会員IDを分類して、会員ランク・登録地域・性別などの属性でセグメント分析ができるようにします。
            </div>

            <div class="section">
                <div class="section-header">
                    <h3>元データ（Raw Data）<span class="badge badge-raw">eVar2: member_id</span></h3>
                </div>
                <div class="table-wrapper">
                    <table id="member-raw-table">
                        <thead>
                            <tr>
                                <th>日時</th>
                                <th>会員ID (eVar2)</th>
                                <th>購入回数</th>
                                <th>購入金額</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="edit-controls">
                    <button class="btn btn-secondary" onclick="openAddRawDataModal('member')">+ データ追加</button>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h3>分類テーブル <span class="badge badge-classification">Classification</span></h3>
                </div>
                <div class="table-wrapper">
                    <table id="member-classification-table">
                        <thead>
                            <tr>
                                <th>キー（会員ID）</th>
                                <th>会員ランク</th>
                                <th>登録地域</th>
                                <th>性別</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="edit-controls">
                    <button class="btn btn-primary" onclick="openAddClassificationModal('member')">+ 分類ルール追加</button>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h3>分類結果 <span class="badge badge-result">Classified Data</span></h3>
                </div>
                <div class="table-wrapper">
                    <table id="member-result-table">
                        <thead>
                            <tr>
                                <th>日時</th>
                                <th>会員ID</th>
                                <th>会員ランク</th>
                                <th>登録地域</th>
                                <th>性別</th>
                                <th>購入回数</th>
                                <th>購入金額</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- 分析例セクション -->
            <div class="analysis-section">
                <h3>分析例 <span class="badge badge-workspace">Workspace風レポート</span></h3>
                <p style="font-size: 13px; color: #666; margin-bottom: 20px;">分類を設定することで、以下のような集計レポートをWorkspaceで作成できるようになります。</p>
                <div class="analysis-grid" id="member-analysis"></div>
            </div>
        </div>

        <div class="btn-group" style="margin-top: 30px;">
            <button class="btn btn-success" onclick="saveToLocalStorage()">データを保存</button>
            <button class="btn btn-secondary" onclick="resetToDefault()">初期データにリセット</button>
            <button class="btn btn-secondary" onclick="exportData()">データをエクスポート</button>
        </div>

        <footer>
            Adobe Analytics 分類シミュレーター - 教育・学習目的のデモアプリケーション
        </footer>
    </div>

    <!-- モーダル: 分類ルール追加 -->
    <div class="modal" id="classificationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="classificationModalTitle">分類ルールを追加</h3>
                <button class="modal-close" onclick="closeModal('classificationModal')">&times;</button>
            </div>
            <form id="classificationForm">
                <input type="hidden" id="classificationUseCase">
                <div id="classificationFields"></div>
                <div class="btn-group" style="margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">追加</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('classificationModal')">キャンセル</button>
                </div>
            </form>
        </div>
    </div>

    <!-- モーダル: 元データ追加 -->
    <div class="modal" id="rawDataModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="rawDataModalTitle">元データを追加</h3>
                <button class="modal-close" onclick="closeModal('rawDataModal')">&times;</button>
            </div>
            <form id="rawDataForm">
                <input type="hidden" id="rawDataUseCase">
                <div id="rawDataFields"></div>
                <div class="btn-group" style="margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">追加</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('rawDataModal')">キャンセル</button>
                </div>
            </form>
        </div>
    </div>

    <!-- トースト通知 -->
    <div class="toast" id="toast"></div>

    <script>
        // ===== データ構造 =====
        const defaultData = {
            tracking: {
                rawData: [
                    { datetime: '2024-01-15 08:15:22', key: 'sem_google_brand_2024', pv: 1, cv: 0 },
                    { datetime: '2024-01-15 08:32:45', key: 'sem_google_generic_2024', pv: 1, cv: 1 },
                    { datetime: '2024-01-15 09:05:11', key: 'display_yahoo_banner_winter', pv: 1, cv: 0 },
                    { datetime: '2024-01-15 09:18:33', key: 'sem_google_brand_2024', pv: 1, cv: 1 },
                    { datetime: '2024-01-15 09:45:00', key: 'social_fb_video_newyear', pv: 1, cv: 0 },
                    { datetime: '2024-01-15 10:02:15', key: 'email_newsletter_jan', pv: 1, cv: 1 },
                    { datetime: '2024-01-15 10:23:45', key: 'affiliate_partner_a_link', pv: 1, cv: 0 },
                    { datetime: '2024-01-15 10:45:12', key: 'sem_google_generic_2024', pv: 1, cv: 0 },
                    { datetime: '2024-01-15 11:02:33', key: 'display_yahoo_banner_winter', pv: 1, cv: 1 },
                    { datetime: '2024-01-15 11:15:28', key: 'sem_google_brand_2024', pv: 1, cv: 0 },
                    { datetime: '2024-01-15 11:30:00', key: 'social_instagram_story_winter', pv: 1, cv: 0 },
                    { datetime: '2024-01-15 11:45:22', key: 'sem_yahoo_brand_2024', pv: 1, cv: 1 },
                    { datetime: '2024-01-15 12:00:00', key: 'social_fb_video_newyear', pv: 1, cv: 1 },
                    { datetime: '2024-01-15 12:15:33', key: 'display_gdn_remarketing', pv: 1, cv: 0 },
                    { datetime: '2024-01-15 12:30:15', key: 'email_newsletter_jan', pv: 1, cv: 0 },
                    { datetime: '2024-01-15 12:45:00', key: 'sem_google_generic_2024', pv: 1, cv: 1 },
                    { datetime: '2024-01-15 13:00:22', key: 'affiliate_partner_b_banner', pv: 1, cv: 0 },
                    { datetime: '2024-01-15 13:15:45', key: 'sem_google_brand_2024', pv: 1, cv: 1 },
                    { datetime: '2024-01-15 13:30:11', key: 'display_yahoo_banner_winter', pv: 1, cv: 0 },
                    { datetime: '2024-01-15 13:45:22', key: 'social_twitter_promo_jan', pv: 1, cv: 0 },
                    { datetime: '2024-01-15 14:00:00', key: 'sem_yahoo_brand_2024', pv: 1, cv: 0 },
                    { datetime: '2024-01-15 14:15:33', key: 'email_campaign_sale', pv: 1, cv: 1 },
                    { datetime: '2024-01-15 14:30:45', key: 'sem_google_generic_2024', pv: 1, cv: 0 },
                    { datetime: '2024-01-15 14:45:00', key: 'display_gdn_remarketing', pv: 1, cv: 1 },
                    { datetime: '2024-01-15 15:00:22', key: 'social_fb_video_newyear', pv: 1, cv: 0 },
                    { datetime: '2024-01-15 15:15:11', key: 'affiliate_partner_a_link', pv: 1, cv: 1 },
                    { datetime: '2024-01-15 15:30:33', key: 'sem_google_brand_2024', pv: 1, cv: 0 },
                    { datetime: '2024-01-15 15:45:45', key: 'social_instagram_story_winter', pv: 1, cv: 1 },
                    { datetime: '2024-01-15 16:00:00', key: 'unknown_direct_link', pv: 1, cv: 0 },
                    { datetime: '2024-01-15 16:15:22', key: 'sem_google_generic_2024', pv: 1, cv: 1 }
                ],
                classifications: [
                    { key: 'sem_google_brand_2024', campaign: 'ブランドキャンペーン2024', media: 'Google検索', creative: 'テキスト広告' },
                    { key: 'sem_google_generic_2024', campaign: '一般キーワード2024', media: 'Google検索', creative: 'テキスト広告' },
                    { key: 'sem_yahoo_brand_2024', campaign: 'ブランドキャンペーン2024', media: 'Yahoo検索', creative: 'テキスト広告' },
                    { key: 'display_yahoo_banner_winter', campaign: '冬季セール', media: 'Yahooディスプレイ', creative: 'バナー広告' },
                    { key: 'display_gdn_remarketing', campaign: 'リマーケティング', media: 'GDN', creative: 'バナー広告' },
                    { key: 'social_fb_video_newyear', campaign: '新年キャンペーン', media: 'Facebook', creative: '動画広告' },
                    { key: 'social_instagram_story_winter', campaign: '冬季セール', media: 'Instagram', creative: 'ストーリー広告' },
                    { key: 'social_twitter_promo_jan', campaign: '1月プロモーション', media: 'Twitter', creative: 'プロモツイート' },
                    { key: 'email_newsletter_jan', campaign: '1月ニュースレター', media: 'メール', creative: 'テキスト' },
                    { key: 'email_campaign_sale', campaign: 'セールキャンペーン', media: 'メール', creative: 'HTML' },
                    { key: 'affiliate_partner_a_link', campaign: 'アフィリエイトA', media: 'アフィリエイト', creative: 'テキストリンク' },
                    { key: 'affiliate_partner_b_banner', campaign: 'アフィリエイトB', media: 'アフィリエイト', creative: 'バナー広告' }
                ],
                fields: {
                    raw: ['datetime', 'key', 'pv', 'cv'],
                    rawLabels: ['日時', 'トラッキングコード', 'ページビュー', 'コンバージョン'],
                    classification: ['key', 'campaign', 'media', 'creative'],
                    classificationLabels: ['キー（トラッキングコード）', 'キャンペーン名', '媒体', 'クリエイティブ']
                },
                analysisConfig: {
                    dimensions: ['campaign', 'media', 'creative'],
                    dimensionLabels: ['キャンペーン名', '媒体', 'クリエイティブ'],
                    metrics: ['pv', 'cv'],
                    metricLabels: ['PV', 'CV']
                }
            },
            url: {
                rawData: [
                    { datetime: '2024-01-15 08:00:00', key: '/products/shoes/nike-air-max', pv: 1, duration: 45 },
                    { datetime: '2024-01-15 08:05:22', key: '/products/shoes/adidas-ultraboost', pv: 1, duration: 32 },
                    { datetime: '2024-01-15 08:12:45', key: '/blog/winter-fashion-trends', pv: 1, duration: 120 },
                    { datetime: '2024-01-15 08:20:00', key: '/about/company', pv: 1, duration: 15 },
                    { datetime: '2024-01-15 08:35:33', key: '/products/bags/louis-vuitton', pv: 1, duration: 60 },
                    { datetime: '2024-01-15 08:50:11', key: '/support/faq', pv: 1, duration: 90 },
                    { datetime: '2024-01-15 09:05:00', key: '/products/shoes/nike-air-max', pv: 1, duration: 55 },
                    { datetime: '2024-01-15 09:15:22', key: '/products/watches/rolex-submariner', pv: 1, duration: 80 },
                    { datetime: '2024-01-15 09:30:45', key: '/blog/spring-collection-preview', pv: 1, duration: 95 },
                    { datetime: '2024-01-15 09:45:00', key: '/products/shoes/puma-suede', pv: 1, duration: 40 },
                    { datetime: '2024-01-15 10:00:33', key: '/cart', pv: 1, duration: 25 },
                    { datetime: '2024-01-15 10:15:11', key: '/checkout', pv: 1, duration: 180 },
                    { datetime: '2024-01-15 10:30:00', key: '/products/bags/gucci-marmont', pv: 1, duration: 70 },
                    { datetime: '2024-01-15 10:45:22', key: '/support/contact', pv: 1, duration: 45 },
                    { datetime: '2024-01-15 11:00:45', key: '/products/shoes/nike-air-max', pv: 1, duration: 38 },
                    { datetime: '2024-01-15 11:15:00', key: '/blog/winter-fashion-trends', pv: 1, duration: 110 },
                    { datetime: '2024-01-15 11:30:33', key: '/products/accessories/ray-ban', pv: 1, duration: 50 },
                    { datetime: '2024-01-15 11:45:11', key: '/about/careers', pv: 1, duration: 200 },
                    { datetime: '2024-01-15 12:00:00', key: '/products/shoes/adidas-ultraboost', pv: 1, duration: 42 },
                    { datetime: '2024-01-15 12:15:22', key: '/products/watches/omega-seamaster', pv: 1, duration: 88 },
                    { datetime: '2024-01-15 12:30:45', key: '/cart', pv: 1, duration: 30 },
                    { datetime: '2024-01-15 12:45:00', key: '/products/bags/louis-vuitton', pv: 1, duration: 65 },
                    { datetime: '2024-01-15 13:00:33', key: '/support/returns', pv: 1, duration: 75 },
                    { datetime: '2024-01-15 13:15:11', key: '/blog/sustainable-fashion', pv: 1, duration: 140 },
                    { datetime: '2024-01-15 13:30:00', key: '/products/shoes/nike-air-max', pv: 1, duration: 48 },
                    { datetime: '2024-01-15 13:45:22', key: '/checkout', pv: 1, duration: 150 },
                    { datetime: '2024-01-15 14:00:45', key: '/products/accessories/cartier-bracelet', pv: 1, duration: 92 },
                    { datetime: '2024-01-15 14:15:00', key: '/unknown/new-page', pv: 1, duration: 20 },
                    { datetime: '2024-01-15 14:30:33', key: '/products/shoes/puma-suede', pv: 1, duration: 35 },
                    { datetime: '2024-01-15 14:45:11', key: '/about/company', pv: 1, duration: 18 }
                ],
                classifications: [
                    { key: '/products/shoes/nike-air-max', category: '商品詳細', contentType: '製品ページ', productLine: 'シューズ' },
                    { key: '/products/shoes/adidas-ultraboost', category: '商品詳細', contentType: '製品ページ', productLine: 'シューズ' },
                    { key: '/products/shoes/puma-suede', category: '商品詳細', contentType: '製品ページ', productLine: 'シューズ' },
                    { key: '/products/bags/louis-vuitton', category: '商品詳細', contentType: '製品ページ', productLine: 'バッグ' },
                    { key: '/products/bags/gucci-marmont', category: '商品詳細', contentType: '製品ページ', productLine: 'バッグ' },
                    { key: '/products/watches/rolex-submariner', category: '商品詳細', contentType: '製品ページ', productLine: 'ウォッチ' },
                    { key: '/products/watches/omega-seamaster', category: '商品詳細', contentType: '製品ページ', productLine: 'ウォッチ' },
                    { key: '/products/accessories/ray-ban', category: '商品詳細', contentType: '製品ページ', productLine: 'アクセサリー' },
                    { key: '/products/accessories/cartier-bracelet', category: '商品詳細', contentType: '製品ページ', productLine: 'アクセサリー' },
                    { key: '/blog/winter-fashion-trends', category: 'ブログ', contentType: '記事', productLine: 'コンテンツ' },
                    { key: '/blog/spring-collection-preview', category: 'ブログ', contentType: '記事', productLine: 'コンテンツ' },
                    { key: '/blog/sustainable-fashion', category: 'ブログ', contentType: '記事', productLine: 'コンテンツ' },
                    { key: '/about/company', category: '企業情報', contentType: '静的ページ', productLine: 'コーポレート' },
                    { key: '/about/careers', category: '企業情報', contentType: '静的ページ', productLine: 'コーポレート' },
                    { key: '/support/faq', category: 'サポート', contentType: 'FAQ', productLine: 'カスタマーサービス' },
                    { key: '/support/contact', category: 'サポート', contentType: 'お問い合わせ', productLine: 'カスタマーサービス' },
                    { key: '/support/returns', category: 'サポート', contentType: '返品案内', productLine: 'カスタマーサービス' },
                    { key: '/cart', category: 'カート', contentType: 'トランザクション', productLine: 'EC機能' },
                    { key: '/checkout', category: 'チェックアウト', contentType: 'トランザクション', productLine: 'EC機能' }
                ],
                fields: {
                    raw: ['datetime', 'key', 'pv', 'duration'],
                    rawLabels: ['日時', 'ページURL', 'ページビュー', '滞在時間(秒)'],
                    classification: ['key', 'category', 'contentType', 'productLine'],
                    classificationLabels: ['キー（ページURL）', 'ページカテゴリ', 'コンテンツタイプ', '製品ライン']
                },
                analysisConfig: {
                    dimensions: ['category', 'contentType', 'productLine'],
                    dimensionLabels: ['ページカテゴリ', 'コンテンツタイプ', '製品ライン'],
                    metrics: ['pv', 'duration'],
                    metricLabels: ['PV', '滞在時間(秒)']
                }
            },
            member: {
                rawData: [
                    { datetime: '2024-01-15 08:00:00', key: 'M001234', purchases: 2, amount: 15000 },
                    { datetime: '2024-01-15 08:15:22', key: 'M005678', purchases: 1, amount: 3500 },
                    { datetime: '2024-01-15 08:30:45', key: 'M009012', purchases: 3, amount: 45000 },
                    { datetime: '2024-01-15 08:45:00', key: 'M001234', purchases: 1, amount: 8000 },
                    { datetime: '2024-01-15 09:00:33', key: 'M003456', purchases: 1, amount: 2000 },
                    { datetime: '2024-01-15 09:15:11', key: 'M007890', purchases: 2, amount: 12000 },
                    { datetime: '2024-01-15 09:30:00', key: 'M005678', purchases: 1, amount: 5000 },
                    { datetime: '2024-01-15 09:45:22', key: 'M002345', purchases: 1, amount: 7500 },
                    { datetime: '2024-01-15 10:00:45', key: 'M006789', purchases: 2, amount: 22000 },
                    { datetime: '2024-01-15 10:15:00', key: 'M009012', purchases: 1, amount: 18000 },
                    { datetime: '2024-01-15 10:30:33', key: 'M004567', purchases: 1, amount: 3000 },
                    { datetime: '2024-01-15 10:45:11', key: 'M001234', purchases: 1, amount: 12000 },
                    { datetime: '2024-01-15 11:00:00', key: 'M008901', purchases: 3, amount: 35000 },
                    { datetime: '2024-01-15 11:15:22', key: 'M003456', purchases: 1, amount: 4500 },
                    { datetime: '2024-01-15 11:30:45', key: 'M007890', purchases: 1, amount: 6000 },
                    { datetime: '2024-01-15 11:45:00', key: 'M005678', purchases: 2, amount: 9000 },
                    { datetime: '2024-01-15 12:00:33', key: 'M002345', purchases: 1, amount: 5500 },
                    { datetime: '2024-01-15 12:15:11', key: 'M009012', purchases: 2, amount: 28000 },
                    { datetime: '2024-01-15 12:30:00', key: 'M006789', purchases: 1, amount: 15000 },
                    { datetime: '2024-01-15 12:45:22', key: 'M004567', purchases: 1, amount: 2500 },
                    { datetime: '2024-01-15 13:00:45', key: 'M001234', purchases: 2, amount: 20000 },
                    { datetime: '2024-01-15 13:15:00', key: 'M008901', purchases: 1, amount: 11000 },
                    { datetime: '2024-01-15 13:30:33', key: 'M003456', purchases: 1, amount: 3800 },
                    { datetime: '2024-01-15 13:45:11', key: 'M007890', purchases: 1, amount: 8500 },
                    { datetime: '2024-01-15 14:00:00', key: 'M010123', purchases: 1, amount: 4000 },
                    { datetime: '2024-01-15 14:15:22', key: 'M005678', purchases: 1, amount: 6500 },
                    { datetime: '2024-01-15 14:30:45', key: 'M002345', purchases: 2, amount: 16000 },
                    { datetime: '2024-01-15 14:45:00', key: 'M009012', purchases: 1, amount: 25000 },
                    { datetime: '2024-01-15 15:00:33', key: 'M006789', purchases: 1, amount: 9500 },
                    { datetime: '2024-01-15 15:15:11', key: 'M011234', purchases: 1, amount: 3200 }
                ],
                classifications: [
                    { key: 'M001234', rank: 'ゴールド', region: '東京', gender: '男性' },
                    { key: 'M002345', rank: 'シルバー', region: '神奈川', gender: '女性' },
                    { key: 'M003456', rank: 'ブロンズ', region: '福岡', gender: '女性' },
                    { key: 'M004567', rank: 'ブロンズ', region: '北海道', gender: '男性' },
                    { key: 'M005678', rank: 'シルバー', region: '大阪', gender: '女性' },
                    { key: 'M006789', rank: 'ゴールド', region: '愛知', gender: '男性' },
                    { key: 'M007890', rank: 'ゴールド', region: '名古屋', gender: '男性' },
                    { key: 'M008901', rank: 'プラチナ', region: '東京', gender: '女性' },
                    { key: 'M009012', rank: 'プラチナ', region: '東京', gender: '男性' },
                    { key: 'M010123', rank: 'ブロンズ', region: '京都', gender: '女性' }
                ],
                fields: {
                    raw: ['datetime', 'key', 'purchases', 'amount'],
                    rawLabels: ['日時', '会員ID', '購入回数', '購入金額'],
                    classification: ['key', 'rank', 'region', 'gender'],
                    classificationLabels: ['キー（会員ID）', '会員ランク', '登録地域', '性別']
                },
                analysisConfig: {
                    dimensions: ['rank', 'region', 'gender'],
                    dimensionLabels: ['会員ランク', '登録地域', '性別'],
                    metrics: ['purchases', 'amount'],
                    metricLabels: ['購入回数', '購入金額']
                }
            }
        };

        let appData = JSON.parse(JSON.stringify(defaultData));
        let currentTab = 'tracking';

        // ===== 初期化 =====
        function init() {
            loadFromLocalStorage();
            setupTabs();
            setupForms();
            renderAll();
        }

        // ===== タブ切り替え =====
        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                    tab.classList.add('active');
                    currentTab = tab.dataset.tab;
                    document.getElementById(`${currentTab}-content`).classList.add('active');
                    updateStats();
                });
            });
        }

        // ===== フォーム設定 =====
        function setupForms() {
            document.getElementById('classificationForm').addEventListener('submit', (e) => {
                e.preventDefault();
                addClassification();
            });

            document.getElementById('rawDataForm').addEventListener('submit', (e) => {
                e.preventDefault();
                addRawData();
            });
        }

        // ===== レンダリング =====
        function renderAll() {
            ['tracking', 'url', 'member'].forEach(useCase => {
                renderRawData(useCase);
                renderClassifications(useCase);
                renderResults(useCase);
                renderAnalysis(useCase);
            });
            updateStats();
        }

        function renderRawData(useCase) {
            const tbody = document.querySelector(`#${useCase}-raw-table tbody`);
            const data = appData[useCase].rawData;

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="no-data">データがありません</td></tr>';
                return;
            }

            tbody.innerHTML = data.map((row, index) => {
                const fields = appData[useCase].fields.raw;
                return `<tr>
                    ${fields.map((field, i) =>
                        `<td class="${field === 'key' ? 'key-cell' : ''}">${formatValue(row[field], field)}</td>`
                    ).join('')}
                </tr>`;
            }).join('');
        }

        function renderClassifications(useCase) {
            const tbody = document.querySelector(`#${useCase}-classification-table tbody`);
            const data = appData[useCase].classifications;

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="no-data">分類ルールがありません</td></tr>';
                return;
            }

            tbody.innerHTML = data.map((row, index) => {
                const fields = appData[useCase].fields.classification;
                return `<tr>
                    ${fields.map((field, i) =>
                        `<td class="${field === 'key' ? 'key-cell' : ''}">${row[field]}</td>`
                    ).join('')}
                    <td><button class="btn btn-secondary" style="padding: 5px 10px; font-size: 11px;" onclick="deleteClassification('${useCase}', ${index})">削除</button></td>
                </tr>`;
            }).join('');
        }

        function renderResults(useCase) {
            const tbody = document.querySelector(`#${useCase}-result-table tbody`);
            const rawData = appData[useCase].rawData;
            const classifications = appData[useCase].classifications;

            if (rawData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="no-data">データがありません</td></tr>';
                return;
            }

            const classificationMap = {};
            classifications.forEach(c => {
                classificationMap[c.key] = c;
            });

            tbody.innerHTML = rawData.map(row => {
                const classification = classificationMap[row.key] || {};
                const fields = appData[useCase].fields.classification;
                const rawFields = appData[useCase].fields.raw;
                const hasClassification = !!classificationMap[row.key];

                let html = '<tr>';
                html += `<td>${row.datetime}</td>`;
                html += `<td class="key-cell">${row.key}</td>`;
                fields.slice(1).forEach(field => {
                    const value = classification[field] || '-';
                    html += `<td class="${hasClassification ? 'classified-cell' : ''}">${value}</td>`;
                });
                rawFields.slice(2).forEach(field => {
                    html += `<td>${formatValue(row[field], field)}</td>`;
                });
                html += '</tr>';
                return html;
            }).join('');
        }

        // ===== 分析レポート生成 =====
        function renderAnalysis(useCase) {
            const container = document.getElementById(`${useCase}-analysis`);
            const rawData = appData[useCase].rawData;
            const classifications = appData[useCase].classifications;
            const config = defaultData[useCase].analysisConfig;

            const classificationMap = {};
            classifications.forEach(c => {
                classificationMap[c.key] = c;
            });

            let html = '';

            // 各ディメンションごとに集計パネルを作成
            config.dimensions.forEach((dimension, dimIndex) => {
                const aggregated = {};
                let unclassifiedCount = 0;
                let unclassifiedMetrics = {};
                config.metrics.forEach(m => unclassifiedMetrics[m] = 0);

                rawData.forEach(row => {
                    const classification = classificationMap[row.key];
                    if (classification) {
                        const dimValue = classification[dimension];
                        if (!aggregated[dimValue]) {
                            aggregated[dimValue] = {};
                            config.metrics.forEach(m => aggregated[dimValue][m] = 0);
                        }
                        config.metrics.forEach(m => {
                            aggregated[dimValue][m] += row[m];
                        });
                    } else {
                        unclassifiedCount++;
                        config.metrics.forEach(m => {
                            unclassifiedMetrics[m] += row[m];
                        });
                    }
                });

                // 最初のメトリクスでソート
                const sortedEntries = Object.entries(aggregated).sort((a, b) =>
                    b[1][config.metrics[0]] - a[1][config.metrics[0]]
                );

                // 最大値を取得（バー表示用）
                const maxValue = sortedEntries.length > 0 ?
                    Math.max(...sortedEntries.map(e => e[1][config.metrics[0]])) : 1;

                // 合計計算
                const totals = {};
                config.metrics.forEach(m => {
                    totals[m] = sortedEntries.reduce((sum, [, v]) => sum + v[m], 0);
                });

                html += `
                    <div class="analysis-panel">
                        <div class="analysis-panel-header">
                            <span class="icon"></span>
                            ${config.dimensionLabels[dimIndex]}別レポート
                        </div>
                        <table class="analysis-table">
                            <thead>
                                <tr>
                                    <th>${config.dimensionLabels[dimIndex]}</th>
                                    ${config.metricLabels.map(label => `<th style="text-align: right;">${label}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedEntries.map(([dimValue, metrics]) => {
                                    const barWidth = (metrics[config.metrics[0]] / maxValue * 100);
                                    return `
                                        <tr>
                                            <td class="dimension bar-cell">
                                                <div class="bar-bg" style="width: ${barWidth}%"></div>
                                                <span class="bar-value">${dimValue}</span>
                                            </td>
                                            ${config.metrics.map(m =>
                                                `<td class="metric">${formatValue(metrics[m], m)}</td>`
                                            ).join('')}
                                        </tr>
                                    `;
                                }).join('')}
                                <tr class="total-row">
                                    <td>合計</td>
                                    ${config.metrics.map(m =>
                                        `<td class="metric">${formatValue(totals[m], m)}</td>`
                                    ).join('')}
                                </tr>
                            </tbody>
                        </table>
                        ${unclassifiedCount > 0 ? `
                            <div class="unclassified-note">
                                未分類のデータが ${unclassifiedCount} 件あります
                                (${config.metricLabels.map((label, i) =>
                                    `${label}: ${formatValue(unclassifiedMetrics[config.metrics[i]], config.metrics[i])}`
                                ).join(', ')})
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function formatValue(value, field) {
            if (field === 'amount') {
                return '¥' + value.toLocaleString();
            }
            if (typeof value === 'number') {
                return value.toLocaleString();
            }
            return value;
        }

        function updateStats() {
            const rawCount = appData[currentTab].rawData.length;
            const classificationCount = appData[currentTab].classifications.length;

            const classificationMap = {};
            appData[currentTab].classifications.forEach(c => {
                classificationMap[c.key] = true;
            });

            const classifiedCount = appData[currentTab].rawData.filter(r => classificationMap[r.key]).length;

            document.getElementById('rawDataCount').textContent = rawCount;
            document.getElementById('classificationCount').textContent = classificationCount;
            document.getElementById('classifiedCount').textContent = classifiedCount;
        }

        // ===== モーダル操作 =====
        function openAddClassificationModal(useCase) {
            const fields = appData[useCase].fields.classification;
            const labels = appData[useCase].fields.classificationLabels;

            let html = '';
            fields.forEach((field, i) => {
                html += `
                    <div class="form-group">
                        <label for="class_${field}">${labels[i]}</label>
                        <input type="text" id="class_${field}" name="${field}" required>
                    </div>
                `;
            });

            document.getElementById('classificationFields').innerHTML = html;
            document.getElementById('classificationUseCase').value = useCase;
            document.getElementById('classificationModal').classList.add('active');
        }

        function openAddRawDataModal(useCase) {
            const fields = appData[useCase].fields.raw;
            const labels = appData[useCase].fields.rawLabels;

            let html = '';
            fields.forEach((field, i) => {
                const type = field === 'datetime' ? 'text' : (field === 'key' ? 'text' : 'number');
                const placeholder = field === 'datetime' ? 'YYYY-MM-DD HH:MM:SS' : '';
                html += `
                    <div class="form-group">
                        <label for="raw_${field}">${labels[i]}</label>
                        <input type="${type}" id="raw_${field}" name="${field}" placeholder="${placeholder}" required>
                    </div>
                `;
            });

            document.getElementById('rawDataFields').innerHTML = html;
            document.getElementById('rawDataUseCase').value = useCase;
            document.getElementById('rawDataModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // ===== データ操作 =====
        function addClassification() {
            const useCase = document.getElementById('classificationUseCase').value;
            const fields = appData[useCase].fields.classification;
            const newItem = {};

            fields.forEach(field => {
                newItem[field] = document.getElementById(`class_${field}`).value;
            });

            const exists = appData[useCase].classifications.some(c => c.key === newItem.key);
            if (exists) {
                const index = appData[useCase].classifications.findIndex(c => c.key === newItem.key);
                appData[useCase].classifications[index] = newItem;
                showToast('分類ルールを更新しました');
            } else {
                appData[useCase].classifications.push(newItem);
                showToast('分類ルールを追加しました');
            }

            closeModal('classificationModal');
            renderClassifications(useCase);
            renderResults(useCase);
            renderAnalysis(useCase);
            updateStats();
        }

        function addRawData() {
            const useCase = document.getElementById('rawDataUseCase').value;
            const fields = appData[useCase].fields.raw;
            const newItem = {};

            fields.forEach(field => {
                const value = document.getElementById(`raw_${field}`).value;
                newItem[field] = field === 'datetime' || field === 'key' ? value : parseInt(value);
            });

            appData[useCase].rawData.push(newItem);
            closeModal('rawDataModal');
            renderRawData(useCase);
            renderResults(useCase);
            renderAnalysis(useCase);
            updateStats();
            showToast('データを追加しました');
        }

        function deleteClassification(useCase, index) {
            if (confirm('この分類ルールを削除しますか？')) {
                appData[useCase].classifications.splice(index, 1);
                renderClassifications(useCase);
                renderResults(useCase);
                renderAnalysis(useCase);
                updateStats();
                showToast('分類ルールを削除しました');
            }
        }

        // ===== LocalStorage =====
        function saveToLocalStorage() {
            localStorage.setItem('adobeAnalyticsClassificationData', JSON.stringify(appData));
            showToast('データを保存しました');
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('adobeAnalyticsClassificationData');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    ['tracking', 'url', 'member'].forEach(useCase => {
                        if (parsed[useCase]) {
                            parsed[useCase].fields = defaultData[useCase].fields;
                            parsed[useCase].analysisConfig = defaultData[useCase].analysisConfig;
                        }
                    });
                    appData = parsed;
                } catch (e) {
                    console.error('Failed to parse saved data:', e);
                }
            }
        }

        function resetToDefault() {
            if (confirm('すべてのデータを初期状態にリセットしますか？')) {
                appData = JSON.parse(JSON.stringify(defaultData));
                localStorage.removeItem('adobeAnalyticsClassificationData');
                renderAll();
                showToast('データを初期状態にリセットしました');
            }
        }

        function exportData() {
            const dataStr = JSON.stringify(appData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'classification-data.json';
            a.click();
            URL.revokeObjectURL(url);
            showToast('データをエクスポートしました');
        }

        // ===== ユーティリティ =====
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // 初期化実行
        init();
    </script>
</body>
</html>
